```
% ---------------------------------------------------
%  LAB 1-1
%
%  Run on Windows 7 x64 VM on Linux x64 host.
%
%  Software used in this exercise:
%	- Dependency Walker
%	- PEiD (for pack and encryption of PE)
%	- PEview
% ---------------------------------------------------
```

# Lab1-1

	2. Files compilation dates (based on file properties):
		+ Lab1-1.dll 	| 2010-12-19	10:16	
		+ Lab1-1.exe	| 2012-01-08	01:19

	3. None of the files is obfuscated or encrypted.
		+ Lab1-1.dll -- M$ VS C++ 6.0 DLL
		+ Lab1-1.exe -- M$ VS C++ 6.0 

	Indicators of obfustaction:
	+ Will often include functions such as *LoadLibrary* and
	  *GetProcAddress* -> used for additional functions.
	  It allows to access any function in _any_ library on the system
	
	4. Interesting imports in the malware's files:
	
	+ Lab1-1.exe:
	
		+ Kernel32.dll
			- FindFirstFile / FindNextFile, MapViewOfFile
		-> creates files on the disk
		-> takes arguments from the main
		
		+ (MSVCRT.dll) => ?	
			- _controlfp, _setusermatherr, _setenvi

	+ Lab1-1.dll
		
		+ Kernel32.dll
			- sleep
		-> create process + mutex
		
		+ WS2_32.dll => likely connects to the network
			- initterm
		-> almost all are N/A
		
		+ MSCVCRT.dll => ?
		
		Missing imports:
		(GPSVC.dll) => for displaying and manipulating graphics
			- RsopFileAccessCheckInternal

		(IESHIMS.dll) => ?
			- IEShims_Initialize/SetRedirectForThread

# Lab1-2

	2. Lab1-2.exe is packed using UPX version 1.02/1.05 (checked with PEiD)
   	In order to perform further analysis, the file needs
   	to be unpacked with `upx -d` command:
   **!! describe raw data in sections !!**
```
                      Ultimate Packer for eXecutables
                          Copyright (C) 1996 - 2017
UPX 3.94w       Markus Oberhumer, Laszlo Molnar & John Reiser   May 12th 2017

        File size         Ratio      Format      Name
   --------------------   ------   -----------   -----------
     16384 <-      3072   18.75%    win32/pe     Lab01-02.exe
```


## Further Lab1-2.exe analysis:
	1. Compiled on: 2011/01/19	16:10
	2. Imports data (from PEview AddressData):
		+ Kernel32.dll
			- CreateMutex, CreateWaitableTimer, SystemTimeToFileTime, CreateThread
		
		+ ADVAPI32.dll
		creates a service called MalService and connects to a given URL
			- CreateService, OpenSCManager

		+ MSCVRT.dll
			- _initenv, _controlfp, __p__commode

		+ WININET.dll
			- InternetOpenUrl, InternetOpen

### Which URL is malware trying to connect to? (info from .data section + strings)
	http://www.malwareanalysisbook.com using Internet Explorer 8.0


# Lab1-3

	1. Compiled on: 2011/03/26 06:54 (data unavailable in PEView) 
	2. The file is packed using FSG 1.0 -> dulek/xt.

	How to unpack it? Found information about some plugins to PEiD (generic unpacker) 
	but I decided to follow manual approach, described in the link below.
	
[Manual approach](https://www.aldeid.com/wiki/Category:Digital-Forensics/Computer-Forensics/Anti-Reverse-Engineering/Packers/FSG#tab=Unpacking_FSG_1_0 "FSG Unpacking").
**Note:** I have configured OllyDump plugin before unpacking, donwloaded from OpenRCE.
	  Remember, the beginning of the executable: __0x401000__.

## Further Lab01-03.exe analysis:

	After unpacking with OllyDump, the file was examinated with PEiD again.
	It is a console win32 application

	1. Imports data:
	+ ole32.dll
	OLE windows library to implement mechanism provided by COM to 
	transfer data between applications
		- CoCreateInstance, OleInitialize

	+ MSCVRT.dll
		- _controlfp, _initterm, __set_app_type

	+ NTDLL.dll
		- NtOpenKey, NtQueryObject, NtQuerySystemInformation

	+ GDI32.dll
		- CreateBitmap, CreatePallete

	+ MPR.dll
		- WNetGetConnection

	+ KERNELBASE.dll

	+ KERNEL32.dll
		- IsWow64Process, LoadLibraryA, GetSystemWow64Directory, CreateSemaphore

	+ USER32.dll => tons of drawing windows, dialog boxes 
		- EnableWindow, DrawIcon, WaitMessage, GetDesktopWindow, GetCursor

	+ RPCRT4.dll
		- NdrClientCall
		
	+ CRYPTSP.dll
		- CryptGenRandom

	+ CRYPT32.dll
		- CertFreeCertificate

	+ IMAGEHLP.dll
		- SymCleanup, StackWalk64

# Lab1-4

	1. Compiled on: 2019/08/30 22:26 (data unavailable in PEView) 
	2. The file is not packed or obfuscated - all data is available in PEView.
	3. Lab01-04 imports:

		+ (KERNEL32.dll)
			- CreateHandle, CreateFile, CreateProcess, CreateRemoteThread,
	  		LoadLibrary, **LoadResource**, WinExec

		+ (NTDLL.dll)
			- NtSleepConditionVariable

		+ KERNELBASE.dll
			- BaseGetProcesDllPath, BaseCompareString, GetUserInfo, OpenRegKey,
	  		GetSystemDefaultUILanguage

		+ ADVAPI32.dll
			- AdjustTokenPrivilages, OpenTokenProcess

		+ MSCVRT.dll
			- _sprintf, _stricmp

(program functionality ?)	

	4. Resources of the binary are stored in .rscr section.
   	After examination with Resource Hacker it can be see that
   	it was one PE file embedded in another.

## The analysis of the inner program:

    1. Compiled on: 2011/02/27 00:16	UTC
    2. The file is not obfuscated or packed. Written in VS C++ 6.0, a GUI application (!)
    3. Imports of the resource:
    + (KERNEL32.dll)
	 	- WinExec, GetTempPath, GetWindowsDirectory, OpenRegKey,
		GetSystemDefaultUILanguage
		
	+ (MOONURL.dll)
	 	- UrlDownloadToFile
		
	+ MSCVRT.dll
	 	- _sprintf	
The inner program connects to the provided address and downloads malicious executable.
   It is done with following command:
   ```
   \winup.exe %s%s \system32\wupdmgrd.exe %s%s http://www.malwareanalysisbook.com/updater.exe
   ```
